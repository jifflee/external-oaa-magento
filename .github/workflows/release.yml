name: Auto Release

on:
  push:
    branches: [main]
    paths: [VERSION]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Read version
        id: version
        run: echo "version=$(cat VERSION | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"

      - name: Check if release exists
        id: check
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        if: steps.check.outputs.exists == 'false'
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "v${{ steps.version.outputs.version }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-external:
    needs: [release]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    env:
      SOURCE_REPO: jifflee/source-oaa-magento
      EXTERNAL_REPO: jifflee/external-oaa-magento

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Read version
        id: version
        run: echo "version=$(cat VERSION | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"

      - name: Push main to external
        run: |
          git remote add external "https://x-access-token:${EXTERNAL_PAT}@github.com/${EXTERNAL_REPO}.git"
          git push external main
        env:
          EXTERNAL_PAT: ${{ secrets.EXTERNAL_PAT }}

      - name: Sync repo metadata
        run: |
          # Read from source using GITHUB_TOKEN (has contents:read on source repo)
          desc=$(GH_TOKEN="${SOURCE_TOKEN}" gh repo view "$SOURCE_REPO" --json description -q '.description')
          topics=$(GH_TOKEN="${SOURCE_TOKEN}" gh repo view "$SOURCE_REPO" --json repositoryTopics -q '.repositoryTopics[].name')

          # Write to external using EXTERNAL_PAT
          GH_TOKEN="${EXTERNAL_TOKEN}" gh repo edit "$EXTERNAL_REPO" --description "$desc" || true
          for topic in $topics; do
            GH_TOKEN="${EXTERNAL_TOKEN}" gh repo edit "$EXTERNAL_REPO" --add-topic "$topic" || true
          done
        env:
          SOURCE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXTERNAL_TOKEN: ${{ secrets.EXTERNAL_PAT }}

      - name: Create release on external
        run: |
          VERSION="v${{ steps.version.outputs.version }}"

          # Skip if release already exists on external
          if GH_TOKEN="${EXTERNAL_TOKEN}" gh release view "$VERSION" --repo "$EXTERNAL_REPO" >/dev/null 2>&1; then
            echo "Release $VERSION already exists on external â€” skipping."
            exit 0
          fi

          # Read release body from source using GITHUB_TOKEN
          body=$(GH_TOKEN="${SOURCE_TOKEN}" gh release view "$VERSION" --repo "$SOURCE_REPO" --json body -q '.body' 2>/dev/null || echo "Release $VERSION")

          # Create release on external using EXTERNAL_PAT
          GH_TOKEN="${EXTERNAL_TOKEN}" gh release create "$VERSION" --repo "$EXTERNAL_REPO" \
            --title "$VERSION" \
            --notes "$body"
        env:
          SOURCE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXTERNAL_TOKEN: ${{ secrets.EXTERNAL_PAT }}
